---
title: "Voter Turnout in 2016"
author: "Alex Nelson"
date: "6/8/2019"
output:
  md_document:
    variant: gfm
    toc: true
    toc_depth: 6
---


```{r setup, include=FALSE}
library(knitr)

library(tidycensus)
library(tidyverse)
library(dplyr)
library(car) # for vif()

library(rjags)
library(runjags)
library(coda)
library(HDInterval)

library(ggplot2)
library(ggmcmc)
library(scales) # for muted()

library(rmarkdown)
library(kableExtra)
knitr::opts_chunk$set(echo = TRUE)
```

# Estimating Turnout

## Exit Poll Data

We try to fit exit poll data, which is extremely noisy.

```{r}
exit_poll_path <- "../data/elections/presidential/exit_polls/cnn_04022017.csv"
exit_poll_df <- read.csv(file=exit_poll_path, header=TRUE, sep=",")
national_exit_polls <- exit_poll_df[which(exit_poll_df$state == 'nation'),]
```

The logistic coefficients we compute:

```{r}
wilson_center <- function(p, n, z) {
  (p + 0.5*z*z/n)/(1.0 + z*z*1.0/n);
}
wilson_width <- function(p, n, z) {
  (z/(1.0 + z*z*1.0/n))*sqrt(p*(1.0-p)/n  + (z*0.5/n)**2);
}
log_coefs <- function(row) {
  # adjust the estimated proportions using center of Wilson interval
  c <- wilson_center(row$Clinton_perc*0.01, row$options_perc*0.01*row$num_respondents,1)
  t <- wilson_center(row$Trump_perc*0.01, row$options_perc*0.01*row$num_respondents,1)
  # then use them for odds-ratios
  row$clinton_numerator <- c/(1.0-c)
  row$trump_numerator <- t/(1.0-t)
  
  row$clinton_coef <- log(row$clinton_numerator)
  row$trump_coef <- log(row$trump_numerator)
  row$log_var <- (2*wilson_width(row$Clinton_perc*0.01, row$options_perc*0.01*row$num_respondents,1)/c)**2 + (2*wilson_width(row$Trump_perc*0.01, row$options_perc*0.01*row$num_respondents,1)/t)**2;
  row$log_sd <- sqrt(row$log_var);
  return(row);
}
```

## Loading Census Data

We load the census data with some helper functions. First, we simply load the data:

```{r}
state_census_data <- function() {
  df <- data.frame()
  for (state in levels(unique(exit_poll_df$state))) {
    if (state != "nation") {
      state_data <- read.csv(file=paste0('D:/src/pa/data/census/acs5/2016/',state,'.csv'),header=TRUE,sep=',')
      df <- rbind(df,state_data)
    }
  }
  df[is.na(df)] <- 0
  df
}
```

Next, we have some helper functions to clean up the data.

```{r}
voting_age_pop <- function(row) {
  sum(row[,c("female.18_19E","female.20E","female.21E","female.22_24E","female.25_29E","female.30_34E","female.35_39E","female.40_44E","female.45_49E","female.50_54E","female.55_59E","female.60_61E","female.62_64E","female.65_66E","female.67_69E","female.70_74E","female.75_79E","female.80_84E","female.85_plusE","male.18_19E","male.20E","male.21E","male.22_24E","male.25_29E","male.30_34E","male.35_39E","male.40_44E","male.45_49E","male.50_54E","male.55_59E","male.60_61E","male.62_64E","male.65_66E","male.67_69E","male.70_74E","male.75_79E","male.80_84E","male.85_plusE")])
}

categorize <- function(census_df) {
  return(census_df %>% transmute(
    name = NAME,
    FIPS = GEOID,
    # age
    age.18_19 = male.18_19E+female.18_19E,
    age.20 = male.20E+female.20E,
    age.21 = male.21E+female.21E,
    age.22_24 = male.22_24E+female.22_24E,
    age.25_29 = male.25_29E+female.25_29E,
    age.30_34 = male.30_34E+female.30_34E,
    age.35_39 = male.35_39E+female.35_39E,
    age.40_44 = male.40_44E+female.40_44E,
    age.45_49 = male.45_49E+female.45_49E,
    age.50_54 = male.50_54E+female.50_54E,
    age.55_59 = male.55_59E+female.55_59E,
    age.60_61 = male.60_61E+female.60_61E,
    age.62_63 = male.62_64E+female.62_64E,
    age.retirees = male.65_66E+male.67_69E+male.70_74E+male.75_79E+male.80_84E+male.85_plusE+female.65_66E+female.67_69E+female.70_74E+female.75_79E+female.80_84E+female.85_plusE,
    # ethnicity
    male.white = male.white.18_19E+male.white.20_24E+male.white.25_29E+male.white.30_34E+male.white.35_44E+male.white.45_54E+male.white.55_64E+male.white.65_74E+male.white.75_84E + male.white.85_plusE + male.white_only.18_19E+male.white_only.20_24E+male.white_only.25_29E+male.white_only.30_34E+male.white_only.35_44E+male.white_only.45_54E+male.white_only.55_64E+male.white_only.65_74E+male.white_only.75_84E + male.white_only.85_plusE + abs(round(rnorm(1,0,max(1,sqrt((male.white.18_19M**2) + (male.white.20_24M**2) + (male.white.25_29M**2) + (male.white.30_34M**2) + (male.white.35_44M**2) + (male.white.45_54M**2) + (male.white.55_64M**2) + (male.white.65_74M**2) + (male.white.75_84M**2) + (male.white.85_plusM**2) + (male.white_only.18_19M**2) + (male.white_only.20_24M**2) + (male.white_only.25_29M**2) + (male.white_only.30_34M**2) + (male.white_only.35_44M**2) + (male.white_only.45_54M**2) + (male.white_only.55_64M**2) + (male.white_only.65_74M**2) + (male.white_only.75_84M**2) + (male.white_only.85_plusM**2)))))),
    female.white = female.white.18_19E+female.white.20_24E+female.white.25_29E+female.white.30_34E+female.white.35_44E+female.white.45_54E+female.white.55_64E+female.white.65_74E+female.white.75_84E+female.white.85_plusE + female.white_only.18_19E+female.white_only.20_24E+female.white_only.25_29E+female.white_only.30_34E+female.white_only.35_44E+female.white_only.45_54E+female.white_only.55_64E+female.white_only.65_74E+female.white_only.75_84E + abs(round(rnorm(1,0,max(1,sqrt((female.white.18_19M**2) + (female.white.20_24M**2) + (female.white.25_29M**2) + (female.white.30_34M**2) + (female.white.35_44M**2) + (female.white.45_54M**2) + (female.white.55_64M**2) + (female.white.65_74M**2) + (female.white.75_84M**2) + (female.white.85_plusM**2) + (female.white_only.18_19M**2) + (female.white_only.20_24M**2) + (female.white_only.25_29M**2) + (female.white_only.30_34M**2) + (female.white_only.35_44M**2) + (female.white_only.45_54M**2) + (female.white_only.55_64M**2) + (female.white_only.65_74M**2) + (female.white_only.75_84M**2) + (female.white_only.85_plusM**2)))))),
    male.black = male.black.18_19E+male.black.20_24E+male.black.25_29E+male.black.30_34E+male.black.35_44E+male.black.45_54E+male.black.55_64E+male.black.65_74E+male.black.75_84E+male.black.85_plusE + abs(round(rnorm(1,0,max(1,abs(round(sqrt((male.black.18_19M**2) + (male.black.20_24M**2) + (male.black.25_29M**2) + (male.black.30_34M**2) + (male.black.35_44M**2) + (male.black.45_54M**2) + (male.black.55_64M**2) + (male.black.65_74M**2) + (male.black.75_84M**2) + (male.black.85_plusM**2)))))))),
    female.black = female.black.18_19E+female.black.20_24E+female.black.25_29E+female.black.30_34E+female.black.35_44E+female.black.45_54E+female.black.55_64E+female.black.65_74E+female.black.75_84E+female.black.85_plusE + abs(round(rnorm(1,0,max(1,abs(round(sqrt((female.black.18_19M**2) + (female.black.20_24M**2) + (female.black.25_29M**2) + (female.black.30_34M**2) + (female.black.35_44M**2) + (female.black.45_54M**2) + (female.black.55_64M**2) + (female.black.65_74M**2) + (female.black.75_84M**2) + (female.black.85_plusM**2)))))))),
    male.hispanic = male.hispanic.18_19E+male.hispanic.20_24E+male.hispanic.25_29E+male.hispanic.30_34E+male.hispanic.35_44E+male.hispanic.45_54E+male.hispanic.55_64E+male.hispanic.65_74E+male.hispanic.75_84E+male.hispanic.85_plusE + abs(round(rnorm(1,0,max(1,abs(round(sqrt((male.hispanic.18_19M**2) + (male.hispanic.20_24M**2) + (male.hispanic.25_29M**2) + (male.hispanic.30_34M**2) + (male.hispanic.35_44M**2) + (male.hispanic.45_54M**2) + (male.hispanic.55_64M**2) + (male.hispanic.65_74M**2) + (male.hispanic.75_84M**2) + (male.hispanic.85_plusM**2)))))))),
    female.hispanic = female.hispanic.18_19E+female.hispanic.20_24E+female.hispanic.25_29E+female.hispanic.30_34E+female.hispanic.35_44E+female.hispanic.45_54E+female.hispanic.55_64E+female.hispanic.65_74E+female.hispanic.75_84E+female.hispanic.85_plusE + abs(round(rnorm(1,0,max(1,abs(round(sqrt((female.hispanic.18_19M**2) + (female.hispanic.20_24M**2) + (female.hispanic.25_29M**2) + (female.hispanic.30_34M**2) + (female.hispanic.35_44M**2) + (female.hispanic.45_54M**2) + (female.hispanic.55_64M**2) + (female.hispanic.65_74M**2) + (female.hispanic.75_84M**2) + (female.hispanic.85_plusM**2)))))))),
    others = male.american_indian.18_19E+male.american_indian.20_24E+male.american_indian.25_29E+male.american_indian.30_34E+male.american_indian.35_44E+male.american_indian.45_54E+male.american_indian.55_64E+male.american_indian.65_74E+male.american_indian.75_84E+male.american_indian.85_plusE+female.american_indian.18_19E+female.american_indian.20_24E+female.american_indian.25_29E+female.american_indian.30_34E+female.american_indian.35_44E+female.american_indian.45_54E+female.american_indian.55_64E+female.american_indian.65_74E+female.american_indian.75_84E+female.american_indian.85_plusE+male.asian.18_19E+male.asian.20_24E+male.asian.25_29E+male.asian.30_34E+male.asian.35_44E+male.asian.45_54E+male.asian.55_64E+male.asian.65_74E+male.asian.75_84E+male.asian.85_plusE+female.asian.18_19E+female.asian.20_24E+female.asian.25_29E+female.asian.30_34E+female.asian.35_44E+female.asian.45_54E+female.asian.55_64E+female.asian.65_74E+female.asian.75_84E+female.asian.85_plusE+male.pacific_islander.18_19E+male.pacific_islander.20_24E+male.pacific_islander.25_29E+male.pacific_islander.30_34E+male.pacific_islander.35_44E+male.pacific_islander.45_54E+male.pacific_islander.55_64E+male.pacific_islander.65_74E+male.pacific_islander.75_84E+male.pacific_islander.85_plusE+female.pacific_islander.18_19E+female.pacific_islander.20_24E+female.pacific_islander.25_29E+female.pacific_islander.30_34E+female.pacific_islander.35_44E+female.pacific_islander.45_54E+female.pacific_islander.55_64E+female.pacific_islander.65_74E+female.pacific_islander.75_84E+female.pacific_islander.85_plusE + abs(round(rnorm(1,0,max(1,abs(round(sqrt((male.american_indian.18_19M**2) + (male.american_indian.20_24M**2) + (male.american_indian.25_29M**2) + (male.american_indian.30_34M**2) + (male.american_indian.35_44M**2) + (male.american_indian.45_54M**2) + (male.american_indian.55_64M**2) + (male.american_indian.65_74M**2) + (male.american_indian.75_84M**2) + (male.american_indian.85_plusM**2) + (female.american_indian.18_19M**2) + (female.american_indian.20_24M**2) + (female.american_indian.25_29M**2) + (female.american_indian.30_34M**2) + (female.american_indian.35_44M**2) + (female.american_indian.45_54M**2) + (female.american_indian.55_64M**2) + (female.american_indian.65_74M**2) + (female.american_indian.75_84M**2) + (female.american_indian.85_plusM**2) + (male.asian.18_19M**2) + (male.asian.20_24M**2) + (male.asian.25_29M**2) + (male.asian.30_34M**2) + (male.asian.35_44M**2) + (male.asian.45_54M**2) + (male.asian.55_64M**2) + (male.asian.65_74M**2) + (male.asian.75_84M**2) + (male.asian.85_plusM**2) + (female.asian.18_19M**2) + (female.asian.20_24M**2) + (female.asian.25_29M**2) + (female.asian.30_34M**2) + (female.asian.35_44M**2) + (female.asian.45_54M**2) + (female.asian.55_64M**2) + (female.asian.65_74M**2) + (female.asian.75_84M**2) + (female.asian.85_plusM**2) + (male.pacific_islander.18_19M**2) + (male.pacific_islander.20_24M**2) + (male.pacific_islander.25_29M**2) + (male.pacific_islander.30_34M**2) + (male.pacific_islander.35_44M**2) + (male.pacific_islander.45_54M**2) + (male.pacific_islander.55_64M**2) + (male.pacific_islander.65_74M**2) + (male.pacific_islander.75_84M**2) + (male.pacific_islander.85_plusM**2) + (female.pacific_islander.18_19M**2) + (female.pacific_islander.20_24M**2) + (female.pacific_islander.25_29M**2) + (female.pacific_islander.30_34M**2) + (female.pacific_islander.35_44M**2) + (female.pacific_islander.45_54M**2) + (female.pacific_islander.55_64M**2) + (female.pacific_islander.65_74M**2) + (female.pacific_islander.75_84M**2) + (female.pacific_islander.85_plusM**2)))))))),
    # education
    education.high_school = male.18_24.less_than_9th_gradeE +  male.18_24.less_than_high_schoolE +  male.18_24.high_school_gradE +  male.25_34.less_than_9th_gradeE +  male.25_34.less_than_high_schoolE +  male.25_34.high_school_gradE +  male.35_44.less_than_9th_gradeE +  male.35_44.less_than_high_schoolE +  male.35_44.high_school_gradE +  male.45_64.less_than_9th_gradeE +  male.45_64.less_than_high_schoolE +  male.45_64.high_school_gradE +  male.65_plus.less_than_9th_gradeE +  male.65_plus.less_than_high_schoolE +  male.65_plus.high_school_gradE +  female.18_24.less_than_9th_gradeE+female.18_24.less_than_high_schoolE+female.18_24.high_school_gradE +  female.25_34.less_than_9th_gradeE +  female.25_34.less_than_high_schoolE +  female.25_34.high_school_gradE +  female.35_44.less_than_9th_gradeE +  female.35_44.less_than_high_schoolE +  female.35_44.high_school_gradE +  female.45_64.less_than_9th_gradeE +  female.45_64.less_than_high_schoolE +  female.45_64.high_school_gradE +  female.65_plus.less_than_9th_gradeE +  female.65_plus.less_than_high_schoolE +  female.65_plus.high_school_gradE,
    education.some_college = male.18_24.some_collegeE+male.18_24.associate_degreeE+male.25_34.some_collegeE+male.25_34.associate_degreeE+male.45_64.some_collegeE+male.45_64.associate_degreeE+male.65_plus.some_collegeE+male.65_plus.associate_degreeE+female.18_24.some_collegeE+female.18_24.associate_degreeE+female.25_34.some_collegeE+female.25_34.associate_degreeE+female.45_64.some_collegeE+female.45_64.associate_degreeE+female.65_plus.some_collegeE+female.65_plus.associate_degreeE,
    education.college_grad = male.18_24.bachelor_degreeE + male.25_34.bachelor_degreeE + male.35_44.bachelor_degreeE + male.45_64.bachelor_degreeE + male.65_plus.bachelor_degreeE + female.18_24.bachelor_degreeE + female.25_34.bachelor_degreeE + female.35_44.bachelor_degreeE + female.45_64.bachelor_degreeE + female.65_plus.bachelor_degreeE,
    education.postgrad = male.18_24.graduate_degreeE + male.25_34.graduate_degreeE + male.35_44.graduate_degreeE + male.45_64.graduate_degreeE + male.65_plus.graduate_degreeE + female.18_24.graduate_degreeE + female.25_34.graduate_degreeE + female.35_44.graduate_degreeE + female.45_64.graduate_degreeE + female.65_plus.graduate_degreeE
  ))
}
```

We load and categorize the Census data from 2016:

```{r}
census_data <- categorize(state_census_data())
```

We will need to regress against the election data by county level, to figure out voter turnout.

```{r}
load('D:/src/pa/data/elections/presidential/county/countypres_2000-2016.RData')
election_2016 <- x[which(x$year == 2016),]
#data <- inner_join(election_2016[which(election_2016$party=='democrat' | election_2016$party == 'republican'),c('FIPS','candidate','party','candidatevotes','totalvotes')],categorize_state(fl_census_data),by='FIPS')
```

# Walking to the polls

Gelman, Carilin, Stern, and Rubin's _Bayesian Data Analysis_ (Second ed.) discusses Melbourne school children walking to school, and that basic model applies to walking to the polls to vote. The variables in question, slightly reprashed in our model's domain specific terminology:

+ `y[i,j,k] = 1` if the person `i` in ~~class~~ ethnic group `j` (in ~~school~~ county `k`) walked to the poll to vote
+ `y[i,j,k] = 0` if person `i` did not vote
+ `M[k] = 7` is the number of ethnic groups we're considering
+ `N[k]` is the number of people in county `k`
+ `N[j,k]` is the number of people of ethnic group `j` living in county `k`
+ `N` is the total number of people in the state
+ `y_bar[j,k]` is the proportion of ~~students at school `k`~~ people of ethnic group `j` in county `k` who voted
+ `y_bar[k]` is the proportion of people in county `k` who voted
+ `y_bar` is the proportion of people in the state who voted

We assume `Pr(y[i,j,k]) = theta[j,k]` all the individuals are independent random variables. We also model `y_bar[j,k] ~ Binomial(prob=theta[j,k], size=N[j,k])`. 

# Model for Voter Turnout (Test Case: Arizona)

To gauge how good our test case is, we use the RMSE.

```{r}
rmse <- function(actual, predicted) {
  sqrt(mean((actual - predicted)**2))
}
```

Then we simply follow the model outlined above, but with the additional constraint that the state-wide vote counts must be "near" the predicted voter turnout (modulo some noise).

```{r}
cat(paste0(
"model
{
  # likelihood
  tv ~ dnorm(sum(mw,fw,mb,fb,ml,fl,ov),2764143243)
  for (i in 1:N) {
    totalvotes[i] ~ dnorm(mw[i] + fw[i] + mb[i] + fb[i] + ml[i] + fl[i] + ov[i], 983241381);
    
    mw[i] ~ dbin(p_male_white[i], male.white[i]);
    fw[i] ~ dbin(p_female_white[i], female.white[i]);
    mb[i] ~ dbin(p_male_black[i], max(1, male.black[i]));
    fb[i] ~ dbin(p_female_black[i], max(1, female.black[i]));
    ml[i] ~ dbin(p_male_latino[i], max(1,male.hispanic[i]));
    fl[i] ~ dbin(p_female_latino[i], max(1,female.hispanic[i]));
    ov[i] ~ dbin(p_others[i], max(1, others[i]));
  }
  # prior
  for (i in 1:N) {
    p_male_white[i] ~ dbeta(w_male_white*male.white[i] + 1, (1 - w_male_white)*male.white[i] + 1)
    p_female_white[i] ~ dbeta(w_female_white*female.white[i] + 1, (1 - w_female_white)*female.white[i] + 1)
    p_male_black[i] ~ dbeta(w_male_black*male.black[i] + 1, (1 - w_male_black)*male.black[i] + 1)
    p_female_black[i] ~ dbeta(w_female_black*female.black[i] + 1, (1 - w_female_black)*female.black[i] + 1)
    p_male_latino[i] ~ dbeta(w_male_latino*male.hispanic[i] + 1, (1 - w_male_latino)*male.hispanic[i] + 1)
    p_female_latino[i] ~ dbeta(w_female_latino*female.hispanic[i] + 1, (1 - w_female_latino)*female.hispanic[i] + 1)
    p_others[i] ~ dbeta(w_others*others[i] + 1, (1 - w_others)*others[i] + 1)
  }
  #w_male_white ~ dbeta(48,52)
  #w_female_white ~ dbeta(27,74)
  #w_male_black ~ dbeta(22,78)
  #w_female_black ~ dbeta(21,79)
  #w_male_latino ~ dbeta(30,70)
  #w_female_latino ~ dbeta(27,73)
  #w_others ~ dbeta(47,53)

  w_male_white ~ dbeta(65,45)
  w_female_white ~ dbeta(65,45)
  w_male_black ~ dbeta(59,41)
  w_female_black ~ dbeta(59,41)
  w_male_latino ~ dbeta(47,53)
  w_female_latino ~ dbeta(47,53)
  w_others ~ dbeta(47,53)

}"), file="az_election2016.model")
```

Then we run the simulation for Arizona:

```{r}
az_data <- inner_join(election_2016[which(election_2016$party=='democrat' & election_2016$state == 'Arizona'),c('FIPS','candidate','party','candidatevotes','totalvotes')],census_data,by='FIPS')
az_data$N <- nrow(az_data)
az_inits <- function() {
  N = nrow(az_data)
  return(list(w_male_white = rbeta(1,48,52),
       w_female_white = rbeta(1,27,74),
       w_male_black = rbeta(1,22,78),
       w_female_black = rbeta(1,21,79),
       w_male_latino = rbeta(1,30,70),
       w_female_latino = rbeta(1,27,73),
       w_others = rbeta(1,47,53),
       p_male_white = rbeta(N,2,2),
       p_female_white = rbeta(N,3,7),
       p_male_black = rbeta(N,2,8),
       p_female_black = rbeta(N,2,8),
       p_male_latino = rbeta(N,3,7),
       p_female_latino = rbeta(N,3,7),
       p_others = rbeta(N,5,5),
       number_of_states = 1
       ))
}
jagsModel = jags.model(file="az_election2016.model" , 
                       data=#append(
                            list(male.white = az_data$male.white,
                                        female.white = az_data$female.white,
                                        male.black = az_data$male.black,
                                        female.black = az_data$female.black,
                                        male.hispanic = az_data$male.hispanic,
                                        female.hispanic = az_data$female.hispanic,
                                        others = az_data$others,
                                        totalvotes = az_data$totalvotes,
                                        tv = sum(az_data$totalvotes),
                                        N = nrow(az_data)),
                                #   inits()
                                #   ),
                       inits=az_inits,
                       n.chains=5, n.adapt=12000)
update(jagsModel, n.iter=2000)
```

```{r}
params <- c('p_male_white','p_female_white','p_male_black','p_female_black','p_male_latino','p_female_latino','p_others')
samps <- coda.samples(jagsModel, params, n.iter=4000*2, thin=2)

mc1 <- as.data.frame(as.matrix(samps))
p_white_male <- rep(0,nrow(az_data))
p_white_female <- rep(0,nrow(az_data))
p_black_male <- rep(0,nrow(az_data))
p_black_female <- rep(0,nrow(az_data))
p_latino_male <- rep(0,nrow(az_data))
p_latino_female <- rep(0,nrow(az_data))
p_others <- rep(0,nrow(az_data))
bad1 <- list(white_male=c(),
             white_female=c(),
             black_male=c(),
             black_female=c(),
             latino_male=c(),
             latino_female=c(),
             others=c());
for(i in 1:nrow(az_data)) {
  prefix = "p_"
  k1 <- paste0(prefix, "male_white[",i,"]");
  r1 <- hdi(mc1[k1]);
  p_white_male[i] <- mean(r1);
  if ((max(r1)-min(r1)) > 0.1) {
    bad1$white_male <- c(bad1$white_male,i)
  }
  k1 <- paste0(prefix, "female_white[",i,"]")
  r1 <- hdi(mc1[k1])
  p_white_female[i] <- mean(r1)
  if ((max(r1)-min(r1)) > 0.1) {
    bad1$white_male <- c(bad1$white_female,i)
  }
  k1 <- paste0(prefix, "male_black[",i,"]")
  r1 <- hdi(mc1[k1])
  p_black_male[i] <- mean(r1)
  if ((max(r1)-min(r1)) > 0.1) {
    bad1$white_male <- c(bad1$black_male,i)
  }
  k1 <- paste0(prefix, "female_black[",i,"]")
  r1 <- hdi(mc1[k1])
  p_black_female[i] <- mean(r1)
  if ((max(r1)-min(r1)) > 0.1) {
    bad1$white_male <- c(bad1$black_female,i)
  }
  k1 <- paste0(prefix, "male_latino[",i,"]")
  r1 <- hdi(mc1[k1])
  p_latino_male[i] <- mean(r1)
  if ((max(r1)-min(r1)) > 0.1) {
    bad1$white_male <- c(bad1$latino_male,i)
  }
  k1 <- paste0(prefix, "female_latino[",i,"]")
  r1 <- hdi(mc1[k1])
  p_latino_female[i] <- mean(r1)
  if ((max(r1)-min(r1)) > 0.1) {
    bad1$white_male <- c(bad1$latino_female,i)
  }
  k1 <- paste0(prefix, "others[",i,"]")
  r1 <- hdi(mc1[k1])
  p_others[i] <- rnorm(1,mean(r1),0.5*(max(r1)-min(r1)))
  if ((max(r1)-min(r1)) > 0.1) {
    bad1$white_male <- c(bad1$others,i)
  }
}

err <- (p_white_male*az_data$male.white + p_white_female*az_data$female.white + p_black_male*az_data$male.black + p_black_female*az_data$female.black + p_latino_male*az_data$male.hispanic + p_latino_female*az_data$female.hispanic + p_others*az_data$others - az_data$totalvotes)/az_data$totalvotes;
err
```

It's hard to gauge how bad this is, since anything over 100 votes "sounds scary". Lets see the RMSE, which is in units of "votes", and what fraction of the total votes is in error:

```{r}
rmse(az_data$totalvotes, p_white_male*az_data$male.white + p_white_female*az_data$female.white + p_black_male*az_data$male.black + p_black_female*az_data$female.black + p_latino_male*az_data$male.hispanic + p_latino_female*az_data$female.hispanic + p_others*az_data$others)
```

And as a fraction of total votes:

```{r}
rmse(az_data$totalvotes, p_white_male*az_data$male.white + p_white_female*az_data$female.white + p_black_male*az_data$male.black + p_black_female*az_data$female.black + p_latino_male*az_data$male.hispanic + p_latino_female*az_data$female.hispanic + p_others*az_data$others)/sum(az_data$totalvotes)
```

